var kclient=angular.module("kurentinoClient",["templatescache"]);kclient.config(function(e){e.debugEnabled(!0)}),kclient.controller("mainCtrl",function(e){e.vars={socket:new WebSocket("wss://"+location.host+":8025"),logged:!1,sendPeer:null},e.connectedPeers=[],e.peersMap={},e.clientMsgTypes={LOGIN:"login",LOGOUT:"logout",CLIENT_ERROR:"error",OFFER:"offerVideo",START_RECORD:"startRec",STOP_RECORD:"stopRec",ON_ICE:"onIceCandidate",OFFER_TO_RECIEVE:"sendVideoTo"},e.serverMsgTypes={COME_IN:"comein",SERVER_ERROR:"error",ICE:"iceCandidate",OFFER_ANSWER:"offerAnswer",NEW_USER:"newParter",EXISTS_LIST:"existsList"};var n=function(e){for(var n="",o="abcdefghijklmnopqrstuvwxyz0123456789",r=o.length;n.length<e;)n+=o[Math.random()*r|0];return n},o=function(){e.$on("$destroy",function(){window.onbeforeunload=void 0}),e.$on("$locationChangeStart",function(n,o,r){confirm("Вы действительно хотите уйти со страницы?")&&(e.vars.socket.close(),n.preventDefault())}),e.vars.loginName=n(9),e.vars.roomName="Тест"};e.login=function(){console.log("Логинимся: "+e.vars.loginName+", комната - "+e.vars.roomName);var n={id:e.clientMsgTypes.LOGIN,name:e.vars.loginName,room:e.vars.roomName};e.sendMessage(n)},e.sendMessage=function(n){var o=JSON.stringify(n);console.log("Сообщение на сервер: "+o),e.vars.socket.send(o)};var r=function(n,o){if(n)return console.error(n);var r={id:e.clientMsgTypes.OFFER,offer:o};e.sendMessage(r)},s=function(){var n={audio:!1,video:{mandatory:{minFrameRate:15}}},o=$("#vid")[0],s={localVideo:o,mediaConstraints:n,onicecandidate:function(n,o){console.log("Кандидат со стороны клиента"),console.log(n);var r={id:e.clientMsgTypes.ON_ICE,candidate:n,name:e.vars.loginName};e.sendMessage(r)}};e.vars.sendPeer=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(s,function(e){return e?console.log(e):void this.generateOffer(r)})};e.startRecord=function(){var n={id:e.clientMsgTypes.START_RECORD};e.sendMessage(n)},e.stopRecord=function(){var n={id:e.clientMsgTypes.STOP_RECORD};e.sendMessage(n)},e.addNewPeer=function(n){e.connectedPeers.push(n),e.$apply()},e.vars.socket.onmessage=function(n){var o=JSON.parse(n.data);switch(o.id){case e.serverMsgTypes.COME_IN:console.log("Вам позволено войти в комнату"),e.vars.logged=!0,e.$apply(),s();break;case e.serverMsgTypes.SERVER_ERROR:console.log("Ошибка сервера");break;case e.serverMsgTypes.OFFER_ANSWER:console.log("Основные пиры: "+JSON.stringify(e.peersMap)),o.name===e.vars.loginName?(console.log("Ответ текущему пользователю"+o.name),e.vars.sendPeer.processAnswer(o.answer,function(e){e&&console.error(e)})):(console.log("Ответ передающему пользователю: "+o.name),e.peersMap[o.name].processAnswer(o.answer,function(e){e&&console.error(e)}));break;case e.serverMsgTypes.ICE:console.log("Пришла метка ICE сервера. Пользователь: "+o.name);var r=JSON.parse(o.candidate);e.vars.sendPeer.addIceCandidate(r,function(e){return e?console.error("Не удалось добавить ICE сервер: "+e):void 0});break;case e.serverMsgTypes.EXISTS_LIST:console.log("Сообщение: "+JSON.stringify(o)),angular.forEach(o.names,function(n,o){var r={};r.name=n,r.width=320,r.height=240,e.addNewPeer(r)});break;case e.serverMsgTypes.NEW_USER:console.log("В комнату вошел новый пользователь: "+o.name);break;default:console.log("Обработчик сообщения еще не имплементирован")}},o()}),kclient.directive("peerViewer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-peer-viewer/template.html"),scope:!0,link:function(e,n,o){e.width=parseInt(o.width,10),e.height=parseInt(o.height,10);var r=o.name;e.videoElem=n.find("video")[0];var s=function(n,o){console.log("Локальный кандидат: "+JSON.stringify(n));var s={id:e.clientMsgTypes.ON_ICE,candidate:n,name:r};e.sendMessage(s)},a=function(n,o,s){if(n)return console.error(n);console.log("Отправка сообщения на прием видео");var a={id:e.clientMsgTypes.OFFER_TO_RECIEVE,sender:r,offer:o};e.sendMessage(a)},t=function(e){return console.log("Пир создан!"),e?console.error(e):void this.generateOffer(a)},i={remoteVideo:e.videoElem,onicecandidate:s};e.peer=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(i,t),e.peersMap[r]=e.peer,console.log("Пиры: "+JSON.stringify(e.peersMap))}}}),kclient.directive("callContainer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-call-container/template.html"),scope:!0,link:function(e,n,o){}}});