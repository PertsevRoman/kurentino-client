var kclient=angular.module("kurentinoClient",["templatescache"]);kclient.config(function(e){e.debugEnabled(!0)}),kclient.controller("mainCtrl",function(e){e.vars={socket:new WebSocket("wss://"+location.host+":8025"),logged:!1,sendPeer:null,currentAudioDevice:"",currentVideoDevice:""},e.connectedPeers=[],e.peersMap={},e.clientMsgTypes={LOGIN:"login",LOGOUT:"logout",CLIENT_ERROR:"error",OFFER:"offerVideo",START_RECORD:"startRec",STOP_RECORD:"stopRec",ON_ICE:"onIceCandidate",OFFER_TO_RECIEVE:"sendVideoTo"},e.serverMsgTypes={COME_IN:"comein",SERVER_ERROR:"error",ICE:"iceCandidate",OFFER_ANSWER:"offerAnswer",NEW_USER:"newParter",EXISTS_LIST:"existsList",REMOVE_USER:"removeUser"},e.audioDevices=[],e.videoDevices=[],e.screenDevices=[];var n=function(e){for(var n="",r="abcdefghijklmnopqrstuvwxyz0123456789",o=r.length;n.length<e;)n+=r[Math.random()*o|0];return n},r=function(){e.vars.loginName=n(9),e.vars.roomName="Тест",e.$apply()};e.$watch("vars.currentAudioDevice",function(e){console.log("Видео: "+e)}),e.$watch("vars.currentVideoDevice",function(e){console.log("Аудио: "+e)}),e.login=function(){console.log("Логинимся: "+e.vars.loginName+", комната - "+e.vars.roomName);var n={id:e.clientMsgTypes.LOGIN,name:e.vars.loginName,room:e.vars.roomName};e.sendMessage(n)},e.createDevicesList=function(e){if(!navigator.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(navigator.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!navigator.enumerateDevices&&navigator.mediaDevices.enumerateDevices&&(navigator.enumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator)),navigator.enumerateDevices){var n={audio:[],video:[]};navigator.enumerateDevices(function(r){angular.forEach(r,function(e){void 0!==n[e.kind]&&n[e.kind].push({deviceId:e.id,label:e.label})}),e(n.audio,n.video)})}else console.error("Невозможно создать список устройств - нет такой функции...")},e.sendMessage=function(n){var r=JSON.stringify(n);console.log("Сообщение на сервер: "+r),e.vars.socket.send(r)};var o=function(n,r){if(n)return console.error(n);var o={id:e.clientMsgTypes.OFFER,offer:r};e.sendMessage(o)},a=function(){var n={audio:{mandatory:{}},video:{mandatory:{maxWidth:800,maxHeight:600,minWidth:160,minHeight:120,maxFrameRate:25}}},r=$(".vid")[0],a={localVideo:r,mediaConstraints:n,onicecandidate:function(n,r){console.log("Кандидат со стороны клиента"),console.log(n);var o={id:e.clientMsgTypes.ON_ICE,candidate:n,name:e.vars.loginName};e.sendMessage(o)}};e.vars.sendPeer=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(a,function(e){return e?console.log(e):void this.generateOffer(o)})};e.startRecord=function(){var n={id:e.clientMsgTypes.START_RECORD};e.sendMessage(n)},e.stopRecord=function(){var n={id:e.clientMsgTypes.STOP_RECORD};e.sendMessage(n)},e.addNewPeer=function(n){e.connectedPeers.push(n),e.$apply()},e.vars.socket.onmessage=function(n){var r=JSON.parse(n.data);switch(r.id){case e.serverMsgTypes.COME_IN:console.log("Вам позволено войти в комнату"),e.vars.logged=!0,e.$apply(),a();break;case e.serverMsgTypes.SERVER_ERROR:console.log("Ошибка сервера");break;case e.serverMsgTypes.OFFER_ANSWER:console.log("Основные пиры: "+JSON.stringify(e.peersMap)),r.name===e.vars.loginName?(console.log("Ответ текущему пользователю"+r.name),e.vars.sendPeer.processAnswer(r.answer,function(e){e&&console.error(e)})):(console.log("Ответ передающему пользователю: "+r.name),e.peersMap[r.name].processAnswer(r.answer,function(e){e&&console.error(e)}));break;case e.serverMsgTypes.ICE:console.log("Пришла метка ICE сервера. Пользователь: "+r.name);var o=JSON.parse(r.candidate);if(r.name===e.vars.loginName)e.vars.sendPeer.addIceCandidate(o,function(e){return e?console.error("Не удалось добавить ICE сервер для передающего пира: "+e):void 0});else{if(void 0===e.peersMap[r.name])return console.error("Нет пира с таким именем");e.peersMap[r.name].addIceCandidate(o,function(e){return console.log("Обработан кандидат для принимающего пира..."),e?console.error("Не удалось добавить ICE сервер для принимающего пира: "+e):void 0})}break;case e.serverMsgTypes.EXISTS_LIST:console.log("Сообщение: "+JSON.stringify(r)),angular.forEach(r.names,function(n,r){var o={};o.name=n,o.width=320,o.height=240,e.addNewPeer(o)});break;case e.serverMsgTypes.NEW_USER:console.log("В комнату вошел новый пользователь: "+r.name);break;case e.serverMsgTypes.REMOVE_USER:console.log("Удаление пользователя: "+r.name),e.peersMap[r.name].dispose(),e.connectedPeers=e.connectedPeers.filter(function(e){return e.name!==r.name}),e.$apply();break;default:console.log("Обработчик сообщения еще не имплементирован")}},e.createDevicesList(function(n,o){e.audioDevices=n,e.videoDevices=o,r()})}),kclient.directive("peerViewer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-peer-viewer/template.html"),scope:!0,link:function(e,n,r){e.width=parseInt(r.width,10),e.height=parseInt(r.height,10),e.vid=parseInt(r.vid,10);var o=r.name;e.overed=!1,e.maximized=!1,e.overMouse=function(){e.overed=!0},e.leaveMouse=function(){e.overed=!1},e.videoElem=n.find("video")[0];var a=function(n,r){console.log("Локальный кандидат: "+JSON.stringify(n));var a={id:e.clientMsgTypes.ON_ICE,candidate:n,name:o};e.sendMessage(a)},i=function(n,r,a){if(n)return console.error(n);console.log("Отправка сообщения на прием видео");var i={id:e.clientMsgTypes.OFFER_TO_RECIEVE,sender:o,offer:r};e.sendMessage(i)},s=function(e){return console.log("Пир создан!"),e?console.error(e):void this.generateOffer(i)},t={audio:!0,video:{mandatory:{maxWidth:800,maxHeight:600,minWidth:320,minHeight:240,minFrameRate:10}}},c={remoteVideo:e.videoElem,mediaConstraints:t,onicecandidate:a};e.peer=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(c,s),e.peersMap[o]=e.peer,console.log("Пиры: "+JSON.stringify(e.peersMap))}}}),kclient.directive("callContainer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-call-container/template.html"),scope:!0,link:function(e,n,r){}}});