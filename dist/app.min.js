var kclient=angular.module("kurentinoClient",["templatescache"]);kclient.config(function(e){e.debugEnabled(!0)}),kclient.controller("mainCtrl",function(e){e.vars={socket:new WebSocket("wss://localhost:8025"),logged:!1,sendPeer:null},e.clientMsgTypes={LOGIN:"login",LOGOUT:"logout",CLIENT_ERROR:"error",OFFER:"offerVideo",START_RECORD:"startRec",STOP_RECORD:"stopRec",ON_ICE:"onIceCandidate"},e.serverMsgTypes={COME_IN:"comein",SERVER_ERROR:"error",ICE:"iceCandidate",OFFER_ANSWER:"offerAnswer"};var n=function(){e.$on("$destroy",function(){window.onbeforeunload=void 0}),e.$on("$locationChangeStart",function(n,o,r){confirm("Вы действительно хотите уйти со страницы?")&&(e.vars.socket.close(),n.preventDefault())}),e.vars.loginName="Роман",e.vars.roomName="Тест"};e.login=function(){console.log("Логинимся: "+e.vars.loginName+", комната - "+e.vars.roomName);var n={id:e.clientMsgTypes.LOGIN,name:e.vars.loginName,room:e.vars.roomName};e.sendMessage(n)},e.sendMessage=function(n){var o=JSON.stringify(n);console.log("Сообщение на сервер: "+o),e.vars.socket.send(o)};var o=function(n,o){if(n)return console.error(n);var r={id:e.clientMsgTypes.OFFER,offer:o};e.sendMessage(r)},r=function(){var n={audio:!0,video:{mandatory:{minFrameRate:15}}},r=$("#vid")[0],s={localVideo:r,mediaConstraints:n,onicecandidate:function(n,o){console.log("Кандидат со стороны клиента"),console.log(n);var r={id:e.clientMsgTypes.ON_ICE,candidate:n};e.sendMessage(r)}};e.vars.sendPeer=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(s,function(e){return e?console.log(e):void this.generateOffer(o)})};e.startRecord=function(){var n={id:e.clientMsgTypes.START_RECORD};e.sendMessage(n)},e.stopRecord=function(){var n={id:e.clientMsgTypes.STOP_RECORD};e.sendMessage(n)},e.vars.socket.onmessage=function(n){var o=JSON.parse(n.data);switch(o.id){case e.serverMsgTypes.COME_IN:console.log("Вам позволено войти в комнату"),e.vars.logged=!0,e.$apply(),r();break;case e.serverMsgTypes.SERVER_ERROR:console.log("Ошибка сервера");break;case e.serverMsgTypes.OFFER_ANSWER:console.log("Пользователю пришел ответ"),e.vars.sendPeer.processAnswer(o.answer,function(e){e&&console.error(e)});break;case e.serverMsgTypes.ICE:console.log("Пришла метка ICE сервера. Пользователь: "+o.name);var s=JSON.parse(o.candidate);e.vars.sendPeer.addIceCandidate(s,function(e){return e?console.error("Не удалось добавить ICE сервер: "+e):void 0});break;default:console.log("Обработчик сообщения еще не имплементирован")}},n()}),kclient.directive("peerViewer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-peer-viewer/template.html"),scope:!0,link:function(e,n,o){e.width=parseInt(o.width,10),e.height=parseInt(o.height,10),e.videoElem=n.find("video")[0];var r=function(n,o){console.log("Local candidate"+JSON.stringify(n));var r={id:"onIceCandidate",candidate:n,name:name};e.sendMessage(r)},s=function(n,o,r){if(n)return console.error("sdp offer error");console.log("Invoking SDP offer callback function");var s={id:"receiveVideoFrom",sender:name,sdpOffer:o};e.sendMessage(s)},t=function(e){return console.log("Пир создан!"),e?console.error(e):void this.generateOffer(s)},a={remoteVideo:e.videoElem,onicecandidate:r};e.peer=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(a,t)}}}),kclient.directive("callContainer",function(e){return{restrict:"E",replace:!0,template:e.get("./dist/kc-call-container/template.html"),scope:!0,link:function(e,n,o){e.connectedPeers=[]}}});